<!DOCTYPE html>
<html>

<head>
      <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v -->



<meta name="generator" content="Jekyll v4.3.2" />





<meta property="og:locale" content="" />

  <link rel="shortcut icon" type="image/png" href="/webdataconnector/assets/logo.png">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/webdataconnector/assets/css/main.css">
  <link rel="stylesheet" href="/webdataconnector/assets/css/github-highlight.css">

  <script src="/webdataconnector/assets/js/redirect-to-search.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>



</head>

<body>
    <div class="container">
        <header class="site-header">
  <div class="wrapper">
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand navbar-brand-logo" href="/webdataconnector/#">Tableau Web Data Connector</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/webdataconnector/docs/index.html">Docs</a></li>
            <li><a href="/webdataconnector/docs/api_ref.html">API Reference</a></li>
            <li><a href="/webdataconnector/community/">Community Connectors</a></li>
            <li><a target="_blank" href="https://community.tableau.com/s/topic/0TO4T000000QFBJWA4/web-data-connector">Forum</a></li>
            <li><a href="/webdataconnector/news/">What's New?</a></li>
            
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="tableauIcon"><a target="_blank" href="http://tableau.com"><img src="/webdataconnector/assets/logo.png" alt="Tableau Developers" class="logo" /></a></li>
            <li><a target="_blank" href="https://github.com/tableau/webdataconnector"><span class="icon icon--github" title="WDC on GitHub" alt="WDC on GitHub"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
  </div>
</header>

        <div class="well docs-menu col-xs-12 col-sm-4 col-md-3">
    <div class="search-container form-group has-feedback">
    <form id="docs-search">
        <input type="search" id="search-input" class="custom-search form-control" placeholder="Search the docs..." search-url="/webdataconnector/docs/search.html">
        <span class="glyphicon glyphicon-search form-control-feedback"></span>
    </form>
</div>


    <ul class="nav nav-list">
        <li class="nav-header">Overview</li>
        <li>
            <a href="/webdataconnector/docs/index.html">Get Started</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_tutorial.html">Tutorial</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_use_in_tableau.html">Use a WDC in Tableau Desktop</a>
        </li>
		<li>
            <a href="/webdataconnector/docs/wdc_use_in_server.html">Use a WDC in Tableau Server</a>
        </li>

        <li class="nav-header">Basic Concepts</li>
        <li>
            <a href="/webdataconnector/docs/wdc_phases.html">Lifecycle and Phases</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_library_versions.html">API Versions</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_samples.html">Samples</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_debugging.html">Debugging in the Simulator and Tableau</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_hosting_and_submissions.html">Hosting and Submitting to Community Portal</a>
        </li>

        <li class="nav-header">Advanced Concepts</li>
        <li>
            <a href="/webdataconnector/docs/wdc_multi_table_tutorial.html">Multiple Tables Tutorial</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_oauth_tutorial.html">Node.js Proxy with OAuth Tutorial</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_standard_connections.html">Standard Connections</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_join_filtering.html">Join Filtering</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_custom_init_and_shutdown.html">Custom Initialization and Shutdown</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_get_data.html">Get Data: Best Practices</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_incremental_refresh.html">Incremental Refresh</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_authentication.html">Authentication</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_cors.html">Working with CORS</a>
        </li>

        <li class="nav-header">Reference</li>
        <li>
            <a href="/webdataconnector/docs/wdc_resources.html">Resources</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_ref_date_formats.html">Supported Date Formats</a>
        </li>
        <li>
            <a href="/webdataconnector/docs/wdc_faq.html">FAQ</a>
        </li>
		    <li>
		    <a href="/webdataconnector/docs/wdc_upgrade.html">Upgrading from WDC Version 1.x</a>
        </li>
        <li>
		    <a href="/webdataconnector/docs/wdc_webengine.html">Troubleshoot WDC WebEngine Issues</a>
		   </li>
           <li>
		    <a href="/webdataconnector/docs/wdc_about.html">About Tableau Help</a>
		   </li>
    </ul>
</div>


        <div class="content .col-xs-12 .col-sm-8 .col-md-9">
            <h1>WDC Node.js Proxy with OAuth Tutorial</h1>
            <div class="alert alert-info"><p><strong>Important</strong>: Tableau Web Data Connector 2.0 (this version) is being deprecated at Tableau 2023.1 and eventually retired. We will still support WDC 2.0 until its last compatible version of Tableau (Tableau 2022.4) goes End of Life and is no longer supported.</p>

            <p>For information about Tableau Web Data Connector 3.0, see the <a href="https://help.tableau.com/current/api/webdataconnector/en-us/index.html">WDC 3.0 documentation</a>.</p>
            </div>
            <div class="edit-container">
                <a href="https://github.com/tableau/webdataconnector/edit/master/docs/wdc_oauth_tutorial.md" class="edit-links"><span class="glyphicon glyphicon-pencil"></span> Edit this page</a>
                &nbsp;
                <a href="https://github.com/tableau/webdataconnector/issues" class="edit-links"><span class="glyphicon glyphicon-flag"></span> Submit an issue</a>
            </div>
            <br />
            <h2><a name="top"></a></h2>
<p>This tutorial builds on what you learned about web data connectors in the <a href="/webdataconnector/docs/wdc_tutorial.html">Basic tutorial</a>. Ensure that you understand the concepts in the basic tutorial before you continue.</p>

<p>By the end of this tutorial, you’ll have a working WDC that connects to <a href="https://foursquare.com">Foursquare</a> and downloads data for sites that you “liked” in Foursquare.
This is a multi-step tutorial on how to use OAuth with a
Tableau web data connector. Here is a list of all the steps:</p>

<ol>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-1-introduction-and-overview">Introduction and Overview</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-2-create-a-foursquare-app">Create a Foursquare App</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-3-install-and-configure-the-web-server">Install and configure the web server</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-4-create-the-ui-for-signing-in">Create the UI for Signing In</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-5-add-code-for-oauth-sign-in">Add Code for OAuth
Sign-In</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-6-test-oauth-sign-in">Test OAuth Sign-In</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-7-get-columns-and-data">Get Columns and
Data</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-8-manage-credentials">Manage
Credentials</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-9-test-the-connector-in-the-simulator">Test the Connector in the
Simulator</a></li>
  <li><a href="/webdataconnector/docs/wdc_oauth_tutorial.html#step-10-test-the-connector-in-tableau">Test the Connector in
   Tableau</a></li>
</ol>

<p><strong>Note</strong>: To see all the code for the tutorial, see <a href="/webdataconnector/docs/wdc_oauth_tutorial.html#complete-code-listing">Complete Code Listing</a>.</p>

<hr />

<h1 id="step-1-introduction-and-overview">Step 1 Introduction and Overview</h1>

<p>In this part of the tutorial, you’ll learn these things:</p>

<ul>
  <li>
    <p><a href="#tutorial-scenario">The tutorial scenario</a>. This section describes
the web data connector that you’ll build.</p>
  </li>
  <li>
    <p><a href="#prerequisites">Prerequisites</a>. What you’ll need, and what we
assume you already know about web data connectors.</p>
  </li>
  <li>
    <p><a href="#what-is-oath">What is OAuth?</a> If you’re new to OAuth, this section
provides a quick overview.</p>
  </li>
  <li>
    <p><a href="#client-and-server-flow">Which OAuth grant should I use?</a> There are two basic ways to
work with OAuth: One uses the implicit grant and client-side flow, and the other uses the authorization code grant and server-side flow. This
section provides a brief overview of each and when to use them.</p>
  </li>
</ul>

<h2 id="tutorial-scenario">The tutorial scenario</h2>

<p>If you <em>really</em> want to skip all of this and go straight to the source code, look for the <code class="language-plaintext highlighter-rouge">foursquare</code> files in the
<code class="language-plaintext highlighter-rouge">Examples\OAuthProxyExample</code> directory. However, you’ll get a lot more out of this if you build it yourself following along with this tutorial.</p>

<p><strong>Note</strong>: The connector that we’ll create in this tutorial (<code class="language-plaintext highlighter-rouge">foursquareWDC</code>) has a different name than the same
connector in the <code class="language-plaintext highlighter-rouge">Examples\OAuthProxyExample</code> directory (<code class="language-plaintext highlighter-rouge">foursquare</code>). This is to minimize the chances of overwriting
the existing sample. In this tutorial, you copy some of the files over from the existing sample. These are files that you need to set up the web server. You can adapt this process to create and test new connectors that also require OAuth support.</p>

<p>In this tutorial, you’ll build a web data connector that gets data from
Foursquare (<a href="http://foursquare.com">http://foursquare.com</a>). Foursquare is an app that allows
users to search for local services, such as restaurants or attractions.
Foursquare also exposes an API that developers can use to perform many
of the functions that the app has. Foursquare is one of many sites that
use OAuth with their APIs. Others are Facebook, Yelp, Tumblr, Twitter, Spotify, Etsy, and many more.</p>

<p>For this tutorial, you’ll create a web data connector that calls the
Foursquare
<a href="https://developer.foursquare.com/docs/users/venuelikes"><code class="language-plaintext highlighter-rouge">venuelikes</code></a>
endpoint, which returns a list of venues that a specific user has
“Liked” in Foursquare. When you call the <code class="language-plaintext highlighter-rouge">venuelikes</code> endpoint, you must
include an OAuth access token. The token tells Foursquare that the user
has allowed your app—namely, the web data connector—to access the user’s
personal information on Foursquare.</p>

<p><strong>Note</strong>: This tutorial illustrates how to use <a href="http://oauth.net/2/">OAuth
2.0</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>To run this tutorial, you need the following:</p>

<ol>
  <li>
    <p>Basic familiarity with JavaScript.</p>
  </li>
  <li>
    <p>The Web Data Connector SDK installed on your computer.</p>
  </li>
  <li>
    <p>Familiarity with the concepts and web data connector example in the <a href="/webdataconnector/docs/wdc_tutorial.html">Basic tutorial</a>.</p>
  </li>
  <li>
    <p>A web server running locally on your computer and listening on
port 3333. In this tutorial, you will use <a href="https://nodjs.org" target="_blank">Node.js</a> and <a href="https://expressjs.org" target="_blank">Express</a> framework to create a simple web server that will handle the server-side authentication. You can adapt this model to create and test new connectors. We will cover installing and configuring the web server in this tutorial.</p>
  </li>
</ol>

<h2 id="what-is-oath">What is OAuth and how does it work?</h2>

<p>This section provides some basic information about OAuth for those who
are not familiar with it. OAuth is an authentication protocol that
allows an <em>application</em> (in our case, a web data connector) to request
specific resources from a <em>resource provider</em> (Foursquare) on behalf of
a specific <em>resource owner</em> (the user who signs in to Foursquare). This
is a more secure and usable alternative to the application asking the
user directly for their Foursquare username and password.</p>

<p>To use OAuth, an application must be registered with the OAuth
resource provider. For example, in this tutorial, you register your
application with Foursquare. (If you were using a different OAuth
provider, you would register your application with that provider.) The
provider assigns a <em>client ID</em> to identify the application and a <em>client secret</em> that is known only by the application and the OAuth provider and is used to authorize the application to make requests on behalf of the user.
When the application contacts the OAuth provider, the application passes
the client ID to identify itself. The exact process for registering your
application differs for each provider, and is typically explained in the
provider’s documentation for how to use their API.</p>

<p>The following diagram illustrates an example OAuth flow, which is the
flow you will build. The steps following the diagram describe the
steps in the flow.</p>

<p><img src="/webdataconnector/assets/wdc_tutorial_oauth_flow-3.png" alt="" /></p>

<ol>
  <li>
    <p>To connect to data, the end user loads the web data connector in Tableau.</p>
  </li>
  <li>
    <p>The connector displays a button that prompts the user to go to
Foursquare to sign in. When the user clicks the button, the
connector redirects the user to Foursquare to sign in. (The redirect
URL includes the client ID for your connector.)</p>
  </li>
  <li>
    <p>On the Foursquare site, the user signs in and grants permission to
the connector to access the user’s personal information.</p>
  </li>
  <li>
    <p>Foursquare redirects the user back to the connector. As part of the
URL that redirects the user back to the connector, Foursquare
includes an authorization code.</p>
  </li>
  <li>
    <p>The HTTP server we setup with Node.js Express accepts the authorization code and issues a request to Foursquare for an access token. The request includes the client ID and the client secret, a unique identifier that only the server and the Foursquare OAuth provider have knowledge of. The client secret is to ensure that some other application can’t impersonate your connector.</p>
  </li>
  <li>
    <p>Foursquare verifies the authorization code and client secret and returns an access token.</p>
  </li>
  <li>
    <p>The connector includes the access token when it makes requests to
Foursquare endpoints. When Foursquare gets the requests, it
recognizes that the call is on behalf of the user.</p>
  </li>
  <li>
    <p>Foursquare returns the requested information for the user
represented by the access token.</p>
  </li>
</ol>

<h2 id="client-and-server-flow">Which OAuth grant type should I use?</h2>

<p>Applications can use OAuth using one of several grant types. A grant type refers to the way an application goes about getting an access token after a user has authorized the application. Two common ones and the ones described here are the authorization code grant and the implicit grant. The grant type you choose determines the type of authorization flow you use.</p>

<p>With the authorization code grant, the application requests an authorization code when the user signs in, which is then exchanged for an access token. The authorization code grant can be referred to as server-side flow, as the authorization flow goes through the application’s back end (or server-side) code, which handles exchanging the authorization code and the client secret for the access token.</p>

<p>When you use the implicit grant, the application requests the access token, which is returned when the user gives the application permission. This type of grant could be referred to as client-side flow, as the JavaScript that runs in the browser makes the OAuth calls and handles the access token.</p>

<p>The primary motivation for using authorization code grant and the server-side flow is to increase security. In client-side flow, all the information required in order to get an access token is on the client—that is, in JavaScript code. This makes the information visible to anyone who can read that JavaScript code. In the server-side flow, the server keeps the client secret that’s assigned to the app, and the secret is used to get the access token.</p>

<p>Which should you use? A rule of thumb is that if you’re calling
endpoints that require your client secret, you should use the authorization code grant and the server-side flow. The client secret should be kept secure, and the implicit grant and client-side flow potentially exposes the secret. In the server-side flow, the client secret can be kept more secure on the server. We use the authorization code grant and server-side flow in this tutorial.</p>

<p>However, if you’re not calling endpoints that require the client secret,
it’s generally easier to implement the client-side flow.</p>

<p><br /></p>

<hr />

<h1 id="step-2-create-a-foursquare-app">Step 2 Create a Foursquare App</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this part of the tutorial, you’ll create an account with Foursquare
(the OAuth provider) and register your app. You’ll get back a client ID
and client secret that you’ll need for making calls to Foursquare later.</p>

<h2 id="register-your-app-with-foursquare">Register your app with Foursquare</h2>

<p>Before you create the web data connector, you must register your
Foursquare application (the web data connector) on the Foursquare
developer site. When you’re done, you’ll have a client ID that you use
when you communicate with Foursquare and that lets Foursquare know who
is making requests.</p>

<ol>
  <li>
    <p>Go to the <a href="https://foursquare.com/" target="_blank">Foursquare.com</a> site. If you
have a Foursquare developer account, sign in. Otherwise, sign up for
a new account.</p>
  </li>
  <li>
    <p>Go to the <a href="https://foursquare.com/developers/apps">My Apps</a>
page (https://foursquare.com/developers/apps) on the Foursquare
developer website.{:target=”_blank”}</p>
  </li>
  <li>
    <p>Click the <strong>Create a new app</strong> button.</p>
  </li>
  <li>
    <p>Fill in the <strong>Your app name</strong>, <strong>Download/welcome page url</strong>, and <strong>Redirect URI(s)</strong> boxes.</p>

    <p>You can use any values you want for the application name and welcome
page URL. For the <strong>Redirect URI</strong> box,
enter the following:</p>

    <p><code class="language-plaintext highlighter-rouge">http://localhost:3333/redirect</code></p>

    <p>You will use this value later on when you make a call to the
Foursquare OAuth service.</p>
  </li>
  <li>
    <p>Click <strong>Save Changes</strong>.</p>

    <p>Foursquare displays a client ID and a client secret.</p>
  </li>
  <li>
    <p>Copy the client ID and client secret and keep them in a
secure location.</p>

    <p><strong>Note</strong>: For this tutorial, you need the client ID and the client secret. The client ID is used for the initial request for authorization. The client secret is used by the local web server to complete the authorization and to obtain the access token. The client secret must be kept secure and away from public view. In this tutorial, we use the client secret on our web server and not in our Foursquare WDC application, where the JavaScript code is potentially accessible.</p>
  </li>
</ol>

<h2 id="like-some-venues">“Like” some venues</h2>

<p>If you’re new to Foursquare, you don’t have any “Liked” venues. To make
sure you have some data to work with later, do this.</p>

<ol>
  <li>
    <p>Go to the <a href="https://www.foursquare.com" target="_blank">Foursquare.com</a> site and
sign in.</p>
  </li>
  <li>
    <p>Go to the <a href="https://foursquare.com/city-guide" target="_blank">City Guide</a>, and search for venues and display the listing for a venue that you like.</p>
  </li>
  <li>
    <p>Click the “Like” icon for the venue near the top of the listing.</p>

    <p><img src="/webdataconnector/assets/wdc_tutorial_oauth_foursquare_likes2.png" alt="" /></p>
  </li>
  <li>
    <p>Repeat steps 2 and 3 a few times until you have a selection of
“Liked” venues to test later.</p>
  </li>
</ol>

<p><strong>Next</strong></p>

<p>In the next part of the tutorial, you’ll create the folders on your computer where you will host the connector and you will configure the Node.js web server.</p>

<hr />

<h1 id="step-3-install-and-configure-the-web-server">Step 3 Install and configure the web server</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this part of the tutorial, you will create a new directory for your web data connector. You will also copy the Node.js files over from the <code class="language-plaintext highlighter-rouge">Examples\OAuthProxyExample</code>directory and then configure the web server to handle the server side OAuth flow, using the client id and client secret you obtained from Foursquare.</p>

<ol>
  <li>
    <p>Create a directory for this foursquare web data connector under the <code class="language-plaintext highlighter-rouge">Examples</code> folder (for example, <code class="language-plaintext highlighter-rouge">Examples\FoursquareWDC</code>).</p>
  </li>
  <li>
    <p>Copy the following files: <code class="language-plaintext highlighter-rouge">app.js</code>, <code class="language-plaintext highlighter-rouge">config.js</code>, and <code class="language-plaintext highlighter-rouge">package.json</code> from the <code class="language-plaintext highlighter-rouge">Examples\OAuthProxyExample</code> folder to the folder you just created in step 1.</p>
  </li>
  <li>
    <p>After you copy the three files, create a new folder in your directory called <code class="language-plaintext highlighter-rouge">public</code>. You will use this folder later for your connector’s public-facing web page (for example, <code class="language-plaintext highlighter-rouge">Examples\FoursquareWDC\public</code>).</p>
  </li>
  <li>
    <p>Open a Command or shell window and navigate to the directory where you copied the files (<code class="language-plaintext highlighter-rouge">Examples\FoursquareWDC</code>). Install the express server with the following the following command: <strong>npm install</strong> <br />
The command will install all the files you need to run the web server.</p>
  </li>
  <li>
    <p>Configure the web server. Edit the <code class="language-plaintext highlighter-rouge">config.js</code> file in the directory you created and add information about your app. Use <strong>http://localhost</strong> for the <code class="language-plaintext highlighter-rouge">HOSTPATH</code> and the <strong>3333</strong> as the <code class="language-plaintext highlighter-rouge">PORT</code>.  The <code class="language-plaintext highlighter-rouge">REDIRECT_PATH</code> should be <strong>/redirect</strong>.  Your file should look like the following. Replace <code class="language-plaintext highlighter-rouge">YOUR_CLIENT_ID</code> and <code class="language-plaintext highlighter-rouge">YOUR CLIENT_SECRET</code> with the actual values from Foursquare you saved earlier when you registered your app.</p>
  </li>
</ol>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// The necessary configuration for your server</span>
<span class="c1">// Contains credentials for your Foursquare application</span>
<span class="c1">// And the new redirect path for the OAuth flow</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
 <span class="dl">'</span><span class="s1">HOSTPATH</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">PORT</span><span class="dl">'</span><span class="p">:</span> <span class="mi">3333</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">CLIENT_ID</span><span class="dl">'</span><span class="p">:</span>  <span class="dl">'</span><span class="s1">YOUR_CLIENT_ID</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">CLIENT_SECRET</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">YOUR_CLIENT_SECRET</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">REDIRECT_PATH</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/redirect</span><span class="dl">'</span>
<span class="p">};</span>

</code></pre></div></div>

<p>The information you entered in the <code class="language-plaintext highlighter-rouge">config.js</code> file will be used to get the access token from Foursquare. The authorization flow is handled in the web server that you configured, so that the client secret is inaccessible from the public facing web pages that you will create in the next step.</p>

<hr />

<h1 id="step-4-create-the-ui-for-signing-in">Step 4 Create the UI for Signing In</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this part of the tutorial, you create an HTML page that contains
markup for the UI that lets the user sign in to Foursquare. The HTML
page renders the following:</p>

<p><img src="/webdataconnector/assets/wdc_tutorial_oauth_basic_signin_ui.png" alt="" /></p>

<p>You also add JavaScript code that toggles text in the page (“You are
signed in” or “You are not signed in”), depending on whether the user is
signed in.</p>

<h2 id="get-the-button-graphic">Get the button graphic</h2>

<p>The page we are creating uses a graphic for the <strong>Connect to Foursquare</strong> button.</p>

<ul>
  <li>Copy the <code class="language-plaintext highlighter-rouge">foursquare_connect.png</code> file from the <code class="language-plaintext highlighter-rouge">Examples\OAuthProxyExample\public</code> folder and place it in the folder we created for our web page: <code class="language-plaintext highlighter-rouge">Examples\FoursquareWDC\public</code>.</li>
</ul>

<p><img src="/webdataconnector/assets/foursquare_connect.png" alt="" /></p>

<p>If you create a web data connector for a service that uses OAuth or another authorization method, it is best to use the official buttons and logos from the service. Follow whatever guidance the service recommends regarding the use of trademarks and resources, such as buttons and icons. For this tutorial, we downloaded the graphic from the Foursquare resources page: <code class="language-plaintext highlighter-rouge">https://foursquare.com/about/logos</code>. Note that the Foursquare UI for downloading assets might change without notice.</p>

<h2 id="create-the-html-markup">Create the HTML markup</h2>

<ol>
  <li>Create a new file named <code class="language-plaintext highlighter-rouge">index.html</code> in the <code class="language-plaintext highlighter-rouge">Examples\FoursquareWDC\public</code> folder. Then copy the following markup into the new file.</li>
</ol>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Foursquare Connector<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Cache-Control"</span> <span class="na">content=</span><span class="s">"no-store"</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Latest compiled and minified CSS --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Optional theme --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Latest compiled and minified JavaScript --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- Latest WDC Library --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://connectors.tableau.com/libs/tableauwdc-2.2.latest.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- Use to access cookie storage to grab access token --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.2/js.cookie.min.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- This will contain all of your OAuth code --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./foursquareWDC.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: auto; text-align: center; margin-top: 50px; max-width: 300px"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- These labels will toggle depending on whether the user is authenticated or not --&gt;</span>
      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"signedin"</span><span class="nt">&gt;</span>You are signed in!<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"notsignedin"</span><span class="nt">&gt;</span>You are not signed in, please click below to sign in to your Foursquare account.<span class="nt">&lt;/p&gt;</span>

      <span class="c">&lt;!-- The connect to Foursquare button will have a link added to it in the js--&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">id=</span><span class="s">"connectbutton"</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">"./foursquare_connect.png"</span> <span class="na">alt=</span><span class="s">"Login with Foursquare"</span><span class="nt">/&gt;&lt;/a&gt;</span>
      <span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

      <span class="c">&lt;!-- This button will pull the user's liked venues once the user is authenticated --&gt;</span>
      <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-block"</span> <span class="na">id=</span><span class="s">"getvenuesbutton"</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">"glyphicon glyphicon-arrow-down"</span><span class="nt">&gt;&lt;/span&gt;</span> Get Venues I Like<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>At the top of the file, there are <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> elements that link to
various libraries: to Twitter Bootstrap, to jQuery, to the Tableau WDC
library, and to the <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> library. The Bootstrap and jQuery
libraries are optional for web data connectors, but we use them in this
tutorial for professional styling (Bootstrap) and to help with some of
the JavaScript coding (jQuery). The WDC library (currently
<code class="language-plaintext highlighter-rouge">tableauwdc-2.2.latest.js</code>) is required for all WDCs.</p>

<p><strong>Note</strong>: To connect to a web data connector that uses
<code class="language-plaintext highlighter-rouge">tableauwdc-2.2.latest.js</code>, you must be using a recent version of Tableau.
For more information, see <a href="/webdataconnector/docs/wdc_library_versions.html">Web Data Connector Library
Versions</a>.</p>

<p>The <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file is a separate <code class="language-plaintext highlighter-rouge">.js</code> file that you’ll create
shortly. It will contain all the code for making calls to Foursquare.</p>

<p>The page UI consists of a <strong>Connect to
Foursquare</strong> button and a <strong>Get Venues I
Like</strong> button. There is also a single label whose text changes
depending on whether the user is authenticated. If you run the page now,
both labels are shown.</p>

<h3 id="add-code-to-manage-the-ui">Add code to manage the UI</h3>

<p>The next task is to add JavaScript that controls the UI in the page. The
connector should display one label if the user is signed in, and the
other label if not.</p>

<p>You also add code that stores the credentials you need later to make
calls to Foursquare.</p>

<p>In the <code class="language-plaintext highlighter-rouge">Examples\FoursquareWDC\public</code> folder where the <code class="language-plaintext highlighter-rouge">foursquareWDC.html</code> file is, create a file named <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> and copy the following code into it. We will wrap the entire contents of the
<code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file in an immediately invoked function expression
(<a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression" target="_blank">IIFE</a>). This adds a measure of security by preventing other linked scripts from
accessing secure information inside <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

  <span class="c1">// This config stores the important strings needed to</span>
  <span class="c1">// connect to the foursquare API and OAuth service to</span>
  <span class="c1">// gain authorization that we then exchange for an access  </span>
  <span class="c1">// token.</span>
  <span class="c1">//</span>
  <span class="c1">// Do not store your client secret here. </span>
  <span class="c1">// We are using a server-side OAuth flow, and the client </span>
  <span class="c1">// secret is kept on the web server. </span>
  <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">YOUR_CLIENT_ID</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3333/redirect</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">authUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://foursquare.com/</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">20190102</span><span class="dl">'</span>
  <span class="p">};</span> 

  <span class="c1">// more code goes here</span>

<span class="p">})();</span>  <span class="c1">// end of anonymous function</span>


</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">YOUR_CLIENT_ID</code> in the code with the client ID that you got
from Foursquare. This is the same client ID that you put in the <code class="language-plaintext highlighter-rouge">config.js</code> file when you configured the web server.</p>

<p>Use <strong>http://localhost:3333/redirect</strong> as the value of <code class="language-plaintext highlighter-rouge">redirectUri</code>. This is the URL that Foursquare will call after the user has signed in. You can see that the URL includes the path to <code class="language-plaintext highlighter-rouge">redirect</code>, meaning that Foursquare will redirect back to our local web server. The web server will field the response and will extract the access token.  Notice also that the server name for the URL is <code class="language-plaintext highlighter-rouge">localhost:3333</code>, meaning that the redirect will be made to a server
running on your computer. If the web data connector is hosted on another
server, this URL would have to be changed to reflect that.</p>

<p>The <code class="language-plaintext highlighter-rouge">authUrl</code> is the Foursquare address where we send the request for authorization. When the user signs in and grants the web data connector access, Foursquare returns an authorization token.</p>

<p><strong>Important</strong>: The values in the <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file, including your
client ID, could be visible to anyone who can access your web data connector.
Don’t put your client secret here. In this tutorial, we are using the authorization code grant type and server-side flow, so the client secret is not
embedded in this <code class="language-plaintext highlighter-rouge">.js</code> file. The client secret is in the configuration file for the web server that communicates with the OAuth provider. Users of the web data connector never have access to the client secret.</p>

<p>Finally, note that the <code class="language-plaintext highlighter-rouge">config</code> object contains a version value, which
is a date. You must include a version value each time you make a call to
Foursquare. For more information about this value, see <a href="https://developer.foursquare.com/overview/versioning">Versioning
&amp; Internationalization</a>
on the Foursquare website.</p>

<p>Now add the code for managing the UI in the page. Copy the following
code and add it to the <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file below the <code class="language-plaintext highlighter-rouge">config</code> object
definition.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// This function parses the access token in the URI if available</span>
  <span class="c1">// It also adds a link to the foursquare connect button</span>
  <span class="nf">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nf">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">accessToken</span><span class="dl">"</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hasAuth</span> <span class="o">=</span> <span class="nx">accessToken</span> <span class="o">&amp;&amp;</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">);</span>

      <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#connectbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nf">doAuthRedirect</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#getvenuesbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nx">connectionName</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Foursquare Venues Data</span><span class="dl">"</span><span class="p">;</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nf">submit</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>


</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">document.ready</code> function is jQuery code that runs whenever the page
is loaded. The first few lines check to see if the user has already logged in and is already authenticated with the OAuth provider. Because we are handling OAuth using the server-side flow, the server keeps the client secret and handles the required authorization to obtain the access token from Foursquare. The web server can safely pass the access token to our web data connector using browser cookies. The client secret remains secret and unknown to the web data connector. After the authorization state has been checked, the code calls the
<code class="language-plaintext highlighter-rouge">updateUIWithAuthState</code> function, a function that we will add later, which toggles the visibility of text
in the page by setting CSS style attributes for different <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> elements
in the page.</p>

<p>The next section in our <code class="language-plaintext highlighter-rouge">document.ready</code> function links the buttons on the web page to the functions we will add to login to Foursquare (<code class="language-plaintext highlighter-rouge">doAuthRedirect()</code>) and create the web data connector (<code class="language-plaintext highlighter-rouge">getvenuesbutton()</code>).</p>

<hr />

<h1 id="step-5-add-code-for-oauth-sign-in">Step 5 Add Code for OAuth Sign-in</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this part of the tutorial, you add JavaScript code that manages the
OAuth sign-in process to get authorization. When a user clicks the <strong>Connect to Foursquare</strong> button, your code redirects the user to Foursquare, where the user can sign in. After the
user signs in, Foursquare redirects the user back to the local web server with an authorization code. The web server takes the authorization code and adds the client secret in a request back to Foursquare to get the access token that will be used for making requests for data. Foursquare sends the access token back to the web server. The web server saves the access token in the browser cookie, so that the client code (your web data connector) can retrieve it. You’ll add code to retrieve the OAuth access token from the browser cookie.</p>

<h2 id="add-code-for-initial-sign-in">Add code for initial sign-in</h2>

<p>First we’ll add the code to enable the user to log in to Foursquare. Add this to your <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file right after the <code class="language-plaintext highlighter-rouge">$(document).ready</code> method and within the anonymous function.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// An on-click function for the connect to foursquare button,</span>
  <span class="c1">// This will redirect the user to a foursquare login</span>
  <span class="kd">function</span> <span class="nf">doAuthRedirect</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurpose</span> <span class="o">===</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurposeEnum</span><span class="p">.</span><span class="nx">ephemerel</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span>  <span class="c1">// This should be Desktop</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurpose</span> <span class="o">===</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurposeEnum</span><span class="p">.</span><span class="nx">enduring</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span> <span class="c1">// This should be the Tableau Server appID</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">authUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">oauth2/authenticate?response_type=code&amp;client_id=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">appId</span> <span class="o">+</span>
              <span class="dl">'</span><span class="s1">&amp;redirect_uri=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">redirectUri</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span> 
</code></pre></div></div>

<p>You will notice that the first part of the code for the <code class="language-plaintext highlighter-rouge">doAuthRedirect()</code> method checks the <code class="language-plaintext highlighter-rouge">tableau.authPurpose</code> enum before selecting the client ID to use. The conditional check is because you might have two different client IDs for the web data connector: one for Tableau Desktop and one for Tableau Server. The reason for multiple client IDs is that some OAuth services limit the number of access tokens that can be granted at a time. This is to avoid situations where a Tableau Desktop user who wants to add a web data connector ends up taking an access token away from a web data connector that is used in a workbook on Tableau Server. For more information, see <a href="/webdataconnector/docs/wdc_authentication.html#auth-purpose">Authentication</a>.</p>

<p>The second part of the <code class="language-plaintext highlighter-rouge">doAuthRedirect()</code> method builds the URL to send to Foursquare to obtain the authorization code. This request includes the client ID and the redirect URI that are declared in the configuration section of this file. The redirect URI is our local web server <code class="language-plaintext highlighter-rouge">http://localhost:3333/redirect</code>. Notice also that the request includes <code class="language-plaintext highlighter-rouge">response_type=code</code>. This indicates that the request is for an authorization code. The web server has the client secret and will use the client secret and the authorization code to acquire the access token.</p>

<h2 id="add-code-to-help-with-the-oauth-requests">Add code to help with the OAuth requests</h2>

<p>Next, we need to add the code to make the request to Foursquare for the venue data when the user clicks the <code class="language-plaintext highlighter-rouge">getvenuesbutton</code>. And we also need to add the code to control which buttons are visible in the UI, depending upon the whether the user is signed in or not.</p>

<p>Add the following code after the <code class="language-plaintext highlighter-rouge">doAuthRedirect()</code> method.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="c1">//------------- OAuth Helpers -------------//</span>
  <span class="c1">// This helper function returns the URI for the venueLikes endpoint</span>
  <span class="c1">// It appends the passed in accessToken to the call to personalize the call for the user</span>
  <span class="kd">function</span> <span class="nf">getVenueLikesURI</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="dl">"</span><span class="s2">https://api.foursquare.com/v2/users/self/venuelikes?oauth_token=</span><span class="dl">"</span> <span class="o">+</span>
              <span class="nx">accessToken</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;v=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// This function toggles the label shown depending</span>
  <span class="c1">// on whether or not the user has been authenticated</span>
  <span class="kd">function</span> <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.notsignedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.signedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.notsignedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">);</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.signedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>



</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">getVenueLikesURI()</code> method creates the request to Foursquare using the access token that was sent to our local web server as part of the authorization flow. The web server saved the access token in a browser cookie and then redirected the browser back to our web data connector. 
The presence of the access token is the first thing the web data connector does on page load in the <code class="language-plaintext highlighter-rouge">$(document).ready()</code> function.</p>

<p>The code that we added also includes the <code class="language-plaintext highlighter-rouge">updateUIWithAuthState</code> method that handles the UI state and displays the buttons appropriately depending upon whether the user is signed in to Foursquare or not.</p>

<h2 id="the-page-so-far">The page so far</h2>

<p>At this point, the <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file has the following content.
(Remember that you must substitute your own client ID in the <code class="language-plaintext highlighter-rouge">config</code>
object.)</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

  <span class="c1">// This config stores the important strings needed to</span>
  <span class="c1">// connect to the foursquare API and OAuth service to</span>
  <span class="c1">// gain authorization that we then exchange for an access  </span>
  <span class="c1">// token.</span>
  <span class="c1">//</span>
  <span class="c1">// Do not store your client secret here. </span>
  <span class="c1">// We are using a server-side OAuth flow, and the client </span>
  <span class="c1">// secret is kept on the web server. </span>
  <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">YOUR_CLIENT_ID</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3333/redirect</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">authUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://foursquare.com/</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">20190102</span><span class="dl">'</span>
  <span class="p">};</span> 
  <span class="c1">// This function parses the access token in the URI if available</span>
  <span class="c1">// It also adds a link to the foursquare connect button</span>
  <span class="nf">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nf">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">accessToken</span><span class="dl">"</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hasAuth</span> <span class="o">=</span> <span class="nx">accessToken</span> <span class="o">&amp;&amp;</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">);</span>

      <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#connectbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nf">doAuthRedirect</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#getvenuesbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nx">connectionName</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Foursquare Venues Data</span><span class="dl">"</span><span class="p">;</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nf">submit</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// An on-click function for the connect to foursquare button,</span>
  <span class="c1">// This will redirect the user to a foursquare login</span>
  <span class="kd">function</span> <span class="nf">doAuthRedirect</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurpose</span> <span class="o">===</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurposeEnum</span><span class="p">.</span><span class="nx">ephemerel</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span>  <span class="c1">// This should be Desktop</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurpose</span> <span class="o">===</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurposeEnum</span><span class="p">.</span><span class="nx">enduring</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span> <span class="c1">// This should be the Tableau Server appID</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">authUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">oauth2/authenticate?response_type=code&amp;client_id=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">appId</span> <span class="o">+</span>
              <span class="dl">'</span><span class="s1">&amp;redirect_uri=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">redirectUri</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//------------- OAuth Helpers -------------//</span>
  <span class="c1">// This helper function returns the URI for the venueLikes endpoint</span>
  <span class="c1">// It appends the passed in accessToken to the call to personalize the call for the user</span>
  <span class="kd">function</span> <span class="nf">getVenueLikesURI</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="dl">"</span><span class="s2">https://api.foursquare.com/v2/users/self/venuelikes?oauth_token=</span><span class="dl">"</span> <span class="o">+</span>
              <span class="nx">accessToken</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;v=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// This function toggles the label shown depending</span>
  <span class="c1">// on whether or not the user has been authenticated</span>
  <span class="kd">function</span> <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.notsignedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.signedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.notsignedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">);</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.signedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
  
  
<span class="p">})();</span>  <span class="c1">// end of anonymous function</span>


</code></pre></div></div>

<p><strong>Next</strong></p>

<p>In the next part of the tutorial, you’ll test the Foursquare sign-in
process.</p>

<h1 id="step-6-test-oauth-sign-in">Step 6 Test OAuth Sign-in</h1>

<p><a href="#top">(Back to top)</a></p>

<p>You can now test OAuth sign-in by starting the local web server. The web server uses Node.js and the Express framework. You can do this test in the browser without using the simulator that is
part of the Web Data Connector SDK.</p>

<ol>
  <li>
    <p>Open a Command Prompt or shell window and go to the folder you created for this tutorial (<code class="language-plaintext highlighter-rouge">Examples\foursquareWDC</code>).</p>
  </li>
  <li>
    <p>Run command: <strong>npm start</strong></p>

    <p><strong>Note</strong>: We’re assuming throughout this tutorial that the web
 server is listening on port 3333 and that the <code class="language-plaintext highlighter-rouge">index.html</code> page
 is in the <code class="language-plaintext highlighter-rouge">Examples\foursquareWDC\public</code> folder of the WDC SDK installation.</p>
  </li>
  <li>
    <p>Open a browser window and enter the following URL:</p>

    <p><code class="language-plaintext highlighter-rouge">http://localhost:3333</code></p>

    <p>You see the following in your browser:</p>

    <p><img src="/webdataconnector/assets/wdc_tutorial_oauth_not_signed_in_ui.png" alt="" /></p>
  </li>
  <li>
    <p>Click <strong>Connect to Foursquare</strong>.</p>

    <p>You see the Foursquare page that prompts you to sign in.</p>

    <p><img src="/webdataconnector/assets/wdc_tutorial_oauth_foursquare_signin.png" alt="" /></p>
  </li>
  <li>
    <p>Sign in and click <strong>Log in and allow</strong>.
Foursquare redirects you back to the web data connector page in
the browser.</p>

    <p><strong>Note:</strong> If you see the message that you are already signed in, you might need to delete cookies from your browsing history. For example, in Chrome, go to <strong>Settings</strong>, click <strong>Advanced</strong>, and choose <strong>Clear Browsing Data</strong>.</p>

    <p>After you have successfully logged in, if you look in the Command Prompt or shell window where you started the server, you should see something similar to the following.</p>

    <pre><code class="language-cmd">
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
Express server listening on port 3333
Auth Code is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
accessToken: BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB

</code></pre>

    <p>When the Express web server starts up, it prints the client ID and the client secret to the console and then listens on port 3333. When the user signs in to Foursquare and grants permission to share data with the web data connector, Foursquare redirects the browser back to the web server with the authorization code. The web server prints out the authorization code and the access token when the authorization process is successful. The connector is now authorized to read your Foursquare info.</p>
  </li>
</ol>

<p><strong>Next</strong></p>

<p>In the next Step of the tutorial, you’ll add the code that runs during
the data-gathering phase of the web data connector to get the schema and
the data.</p>

<hr />

<h1 id="step-7-get-columns-and-data">Step 7 Get Columns and Data</h1>

<p><a href="#top">(Back to top)</a></p>

<p>So far, all the code you’ve added was for getting the OAuth authorization code and the access token. In
this part of the tutorial you’ll add the JavaScript code that all web
data connectors have—code to get the schema (field names and types) for
the data, and to get the data itself. This code is similar to the
equivalent code in the basic tutorial.</p>

<hr />

<h2 id="add-code-to-get-columns-and-data">Add code to get columns and data</h2>

<p>Copy the following code into the bottom of the <code class="language-plaintext highlighter-rouge">foursquareWDC.js</code> file.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
  <span class="c1">//------------- Tableau WDC code -------------//</span>
  <span class="c1">// Create tableau connector, should be called first</span>
  <span class="kd">var</span> <span class="nx">myConnector</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nf">makeConnector</span><span class="p">();</span>



  <span class="c1">// Declare the data to Tableau that we are returning from Foursquare</span>
  <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getSchema</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">schemaCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="kd">var</span> <span class="nx">col1</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Name</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">col2</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Latitude</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">col3</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Longitude</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">col4</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Address</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">cols</span> <span class="o">=</span> <span class="p">[</span><span class="nx">col1</span><span class="p">,</span> <span class="nx">col2</span><span class="p">,</span> <span class="nx">col3</span><span class="p">,</span> <span class="nx">col4</span><span class="p">];</span>

      <span class="kd">var</span> <span class="nx">tableInfo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">FoursquareTable</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">columns</span><span class="p">:</span> <span class="nx">cols</span>
      <span class="p">}</span>

      <span class="nx">schema</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">tableInfo</span><span class="p">);</span>

      <span class="nf">schemaCallback</span><span class="p">(</span><span class="nx">schema</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// This function actually make the foursquare API call and</span>
  <span class="c1">// parses the results and passes them back to Tableau</span>
  <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">doneCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dataToReturn</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">hasMoreData</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">connectionUri</span> <span class="o">=</span> <span class="nf">getVenueLikesURI</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nf">ajax</span><span class="p">({</span>
          <span class="na">url</span><span class="p">:</span> <span class="nx">connectionUri</span><span class="p">,</span>
          <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">success</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
              <span class="nf">if </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">venues</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">venues</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

                  <span class="kd">var</span> <span class="nx">ii</span><span class="p">;</span>
                  <span class="nf">for </span><span class="p">(</span><span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">venues</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
                      <span class="kd">var</span> <span class="nx">venue</span> <span class="o">=</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Name</span><span class="dl">'</span><span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">name</span><span class="p">,</span>
                                   <span class="dl">'</span><span class="s1">Latitude</span><span class="dl">'</span><span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">location</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span>
                                   <span class="dl">'</span><span class="s1">Longitude</span><span class="dl">'</span><span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">location</span><span class="p">.</span><span class="nx">lng</span><span class="p">,</span>
                                   <span class="dl">'</span><span class="s1">Address</span><span class="dl">'</span> <span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">location</span><span class="p">.</span><span class="nx">address</span><span class="p">};</span>
                      <span class="nx">dataToReturn</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">venue</span><span class="p">);</span>
                  <span class="p">}</span>

                  <span class="nx">table</span><span class="p">.</span><span class="nf">appendRows</span><span class="p">(</span><span class="nx">dataToReturn</span><span class="p">);</span>
                  <span class="nf">doneCallback</span><span class="p">();</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">tableau</span><span class="p">.</span><span class="nf">abortWithError</span><span class="p">(</span><span class="dl">"</span><span class="s2">No results found</span><span class="dl">"</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="p">},</span>
          <span class="na">error</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">,</span> <span class="nx">thrownError</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// WDC should do more granular error checking here</span>
              <span class="c1">// or on the server side.  This is just a sample of new API.</span>
              <span class="nx">tableau</span><span class="p">.</span><span class="nf">abortForAuth</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid Access Token</span><span class="dl">"</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>
  <span class="p">};</span>

  <span class="c1">// Register the tableau connector, call this last</span>
  <span class="nx">tableau</span><span class="p">.</span><span class="nf">registerConnector</span><span class="p">(</span><span class="nx">myConnector</span><span class="p">);</span>



</code></pre></div></div>

<p>The code you copied and added to the file follows the same outline as other web data connectors. The code
starts by calling <code class="language-plaintext highlighter-rouge">tableau.makeConnector</code> to create an instance of the
connector. It then adds code to define the data schema
(<code class="language-plaintext highlighter-rouge">getSchema</code>) and to actually fetch the data (<code class="language-plaintext highlighter-rouge">getData</code>).
When the connector is completely configured, the code calls
<code class="language-plaintext highlighter-rouge">tableau.registerConnector</code>.</p>

<p>In this tutorial, the <code class="language-plaintext highlighter-rouge">getSchema</code> function defines four fields
and corresponding data types. The <code class="language-plaintext highlighter-rouge">getData</code> function is similar to the one from the basic tutorial. The code calls the helper
function we added earlier (<code class="language-plaintext highlighter-rouge">getVenueLikesURI</code>) to create the request URI, and then uses jQuery to make an AJAX
call to the data source. When the data is returned, a function in the
success parameter parses the data, creates JavaScript objects out of
each returned value, and then calls the <code class="language-plaintext highlighter-rouge">doneCallback</code> function
to send the data to Tableau.</p>

<p>One difference from the other two WDC tutorials is that this time the <code class="language-plaintext highlighter-rouge">getData</code> function contains these lines:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">connectionUri</span> <span class="o">=</span> <span class="nf">getVenueLikesURI</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">);</span>
</code></pre></div></div>

<p>When the <code class="language-plaintext highlighter-rouge">getData</code> function sends a request to Foursquare, the URL
of the request has to include the access token. You might remember from
the <a href="/webdataconnector/docs/wdc_multi_table_tutorial.html">Multiple Tables Tutorial</a> that you can use the <code class="language-plaintext highlighter-rouge">tableau.connectionData</code>
property to pass values from the interactive (UI) phase of the connector
to the data-gathering phase. (Because the phases run in separate browser
sessions, you can’t use other mechanisms to share values between the
phases.) In the Multiple Tables tutorial, you use <code class="language-plaintext highlighter-rouge">tableau.connectionData</code> to
pass the date object that contains the start and end dates between phases.</p>

<p>When you’re using OAuth, you have the same issue with the access
token—you gather it from the user authorization flow in the interactive phase, but you need
to use it in the data-gathering phase.</p>

<p>You can use the <code class="language-plaintext highlighter-rouge">tableau.password</code> property for this purpose. It’s designed specifically for sensitive
information like passwords or access tokens. The <code class="language-plaintext highlighter-rouge">tableau.password</code> property, like <code class="language-plaintext highlighter-rouge">tableau.connectionData</code>, allows you to pass values between phases of the connector. However, you should never use <code class="language-plaintext highlighter-rouge">tableau.connectionData</code> for sensitive information like passwords or access tokens.</p>

<p>Although the code includes a function to extract the access token, you
haven’t set the value of the <code class="language-plaintext highlighter-rouge">tableau.password</code> yet. You’ll do that
shortly.</p>

<hr />

<h1 id="step-8-manage-credentials">Step 8 Manage Credentials</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this part of the tutorial, you add code to make sure that the
connector has an OAuth access token before it makes requests to
Foursquare. If the access token is not available, you display UI in the
connector to let the user sign in again. You’ll learn about the
following:</p>

<ul>
  <li>
    <p>Persisting credentials in the <code class="language-plaintext highlighter-rouge">tableau.username</code> property.</p>
  </li>
  <li>
    <p>The authorization and authentication (auth) phase of the connector, which occurs if Tableau needs credentials in order to refresh an extract.</p>
  </li>
</ul>

<h2 id="sidebar-credentials-in-web-data-connectors">Sidebar: Credentials in web data connectors</h2>

<p>Before you start this part of the tutorial, it’s helpful to review how
Tableau manages credentials when a user works with a web data connector
in Tableau. If a connector requires basic authentication, you add markup and
code to get credentials from the user. When the user loads the web data
connector into Tableau, the connector goes through its interactive phase
(UI phase) and uses your UI to gather information and credentials from
the user. When you store parameter information in the
<code class="language-plaintext highlighter-rouge">tableau.connectionData</code> property, you store any user credentials in the
<code class="language-plaintext highlighter-rouge">tableau.username</code> and <code class="language-plaintext highlighter-rouge">tableau.password</code> properties. For OAuth
authentication, the process is slightly different, depending upon whether you are using server-side or client-side flow and are using an authorization token and client secret to acquire the access token. In either case, the goal is to end up with an access token you can use to make requests on behalf of the user. For OAuth, you store the access token in the <code class="language-plaintext highlighter-rouge">tableau.password</code>
property.</p>

<p>When the user finishes entering information and credentials, in basic authentication, or finishes the authentication phase with the OAuth provider, Tableau
loads the connector again and the connector goes through its
data-gathering phase. In that phase, Tableau calls the connector’s
<code class="language-plaintext highlighter-rouge">getSchema</code> and <code class="language-plaintext highlighter-rouge">getData</code> functions. When these functions
make calls to the data source, they can get the OAuth access token from
the <code class="language-plaintext highlighter-rouge">tableau.password</code> property and use it when constructing requests to
fetch data.</p>

<p>While the user is working in Tableau, the value in the
<code class="language-plaintext highlighter-rouge">tableau.password</code> property is not persisted between sessions.
Therefore, if the user closes Tableau, re-opens it, and re-loads a
workbook that uses the web data connector, Tableau doesn’t have the
access token. Specifically, there’s no value in the <code class="language-plaintext highlighter-rouge">tableau.password</code>
property.</p>

<p>In that case, Tableau calls the connector just to get the credentials
again. This is referred to as the <em>authentication phase</em> or <em>auth
phase</em>. For connectors that simply get the username and password (such
as a connector that accesses a data source like SQL Server), Tableau can
display a standard sign-in UI. However, Tableau has no built-in UI for
OAuth. Therefore, Tableau has to tell your connector to display the UI
that you’ve created to redirect the user sign in to the OAuth provider.</p>

<p>In the auth phase, the connector should display <em>only</em> the UI that’s
required in order to get the user’s credentials. In this phase, the
connector doesn’t need to ask the user for any other information, such
as query parameter values. (In fact, in the auth phase, Tableau ignores any changes that
you make except those to the <code class="language-plaintext highlighter-rouge">tableau.username</code> and <code class="language-plaintext highlighter-rouge">tableau.password</code>
properties.) To determine whether your connector is being loaded in auth
phase, you can test the <code class="language-plaintext highlighter-rouge">tableau.phase</code> property. The following example
shows how you can determine what phase the connector is in.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Display OAuth authentication UI</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="manage-credentials-during-the-data-gathering-phase">Manage credentials during the data-gathering phase</h2>

<p>Because you’re using OAuth, you have to include custom initialization
logic—that is, you have to include a <code class="language-plaintext highlighter-rouge">tableau.init</code> function in your web
data connector code. (For web data connectors that don’t use OAuth, the
Web Data Connector <code class="language-plaintext highlighter-rouge">.js</code> library provides a default <code class="language-plaintext highlighter-rouge">init</code> function, so
you only need to create an <code class="language-plaintext highlighter-rouge">init</code> function if you need to add custom
initialization code.)</p>

<p>After the call to <code class="language-plaintext highlighter-rouge">tableau.makeConnector</code> and before <code class="language-plaintext highlighter-rouge">myConnector.getSchema</code>, add the following code:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c1">// add this after tableau.makeConnector() function. </span>

  <span class="c1">// Init function for connector, called during every phase but</span>
  <span class="c1">// only called when running inside the simulator or tableau</span>
  <span class="nx">myConnector</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">initCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">tableau</span><span class="p">.</span><span class="nx">authType</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authTypeEnum</span><span class="p">.</span><span class="nx">custom</span><span class="p">;</span>

      <span class="c1">// If we are in the auth phase we only want to show the UI needed for auth</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#getvenuesbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">gatherDataPhase</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If the API that WDC is using has an endpoint that checks</span>
        <span class="c1">// the validity of an access token, that could be used here.</span>
        <span class="c1">// Then the WDC can call tableau.abortForAuth if that access token</span>
        <span class="c1">// is invalid.</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">accessToken</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access token is '</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">accessToken</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">'</span><span class="dl">"</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hasAuth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">accessToken</span> <span class="o">&amp;&amp;</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">);</span>

      <span class="nf">initCallback</span><span class="p">();</span>

      <span class="c1">// If we are not in the data gathering phase, we want to store the token</span>
      <span class="c1">// This allows us to access the token in the data gathering phase</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">interactivePhase</span> <span class="o">||</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">if </span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">accessToken</span><span class="p">;</span>

              <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Auto-submit here if we are in the auth phase</span>
                <span class="nx">tableau</span><span class="p">.</span><span class="nf">submit</span><span class="p">()</span>
              <span class="p">}</span>

              <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">};</span>

    <span class="c1">// The myConnector.getSchema() goes here</span>
</code></pre></div></div>

<h2 id="code-explanation">Code explanation</h2>

<p>The connector’s <code class="language-plaintext highlighter-rouge">init</code> function is called each time that the connector
is loaded. This gives the connector an opportunity to perform any
initialization that the connector requires in each phase. In the <code class="language-plaintext highlighter-rouge">init</code> function, we set the <code class="language-plaintext highlighter-rouge">tableau.authType</code> to <code class="language-plaintext highlighter-rouge">custom</code>, so that we can setup the OAuth flow in the WDC auth phase. The auth phase is similar to the interactive phase. You can determine what phase is active by testing the
<code class="language-plaintext highlighter-rouge">tableau.phase</code> property.</p>

<p>In this connector, one task for the <code class="language-plaintext highlighter-rouge">init</code> function is to get the
access token from the page cookies. As you’ve already seen, during the
interactive phase, the connector redirects to Foursquare, and Foursquare
redirects back to the proxy web server using a URL that includes the authorization token. The proxy web server the sends the authorization token along with the client secret to Foursquare. Foursquare responds by returning the access token in the response. Our Node.js Express web server sets the access token in a client cookie. When the connector is loaded again for the
data-gathering phase, the page checks the validity of the access token before proceeding. If the access token is valid and the connector has authorization (<code class="language-plaintext highlighter-rouge">hasAuth</code>), the connector saves the access token in <code class="language-plaintext highlighter-rouge">tableau.password</code> property. This makes the access token available to the <code class="language-plaintext highlighter-rouge">getData</code> function for the data-gathering phase.</p>

<p>Another task for the <code class="language-plaintext highlighter-rouge">init</code> code is to display the appropriate UI for
the phase that the connector is in, or to test the validity of the access token. These are the conditions:</p>

<ul>
  <li>
    <p>If the user is not signed in to Foursquare, the text “You are not
signed in” should be displayed. This is handled with a call to the
<code class="language-plaintext highlighter-rouge">updateUIWithAuthState</code> helper function that we added to the file earlier.</p>
  </li>
  <li>
    <p>Optionally, call the <code class="language-plaintext highlighter-rouge">tableau.abortForAuth</code> method. This method is
provided for cases where the access token has expired or has been revoked. The <code class="language-plaintext highlighter-rouge">tableau.abortForAuth</code> method must be called from the init method during the gather data phase. Some APIs provide an endpoint for testing the validity of the access token. In that scenario, before fetching data, the WDC would want to call this method in order to re-authenticate the user. See <a href="/webdataconnector/docs/wdc_authentication.html">Authentication</a>.</p>
  </li>
  <li>
    <p>If the connector is in its interactive phase and if the user is not
yet signed in, the <strong>Get Venues I Like</strong>
button should be hidden—this button is useful only after the user is
signed in.</p>
  </li>
  <li>
    <p>Similarly, if the connector is in its auth phase, the only UI that
the page should display is the button that lets the user sign in. In
this tutorial, this also consists of hiding the <strong>Get Venues I Like</strong> button.</p>
  </li>
</ul>

<p>You might recognize some of this logic from the <code class="language-plaintext highlighter-rouge">document.ready</code>
function that you added earlier in the tutorial, where we also call the <code class="language-plaintext highlighter-rouge">updateUIWithAuthState</code> helper function. This allows you to work
with the connector in a browser, which is useful for testing in the
simulator, as we’ll explain in the next part of the tutorial.</p>

<p>As in any web data connector, when the user has finished interacting
with the page, your code sets <code class="language-plaintext highlighter-rouge">tableau</code> object properties like
<code class="language-plaintext highlighter-rouge">connectionName</code> and <code class="language-plaintext highlighter-rouge">connectionData</code> (if required), and calls
<code class="language-plaintext highlighter-rouge">tableau.submit</code> to tell Tableau that the interactive phase is done.
One difference in this <code class="language-plaintext highlighter-rouge">init</code> function, is that when the user has been authenticated, we store the access token in <code class="language-plaintext highlighter-rouge">tableau.password</code>.
line:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">accessToken</span><span class="p">;</span>

</code></pre></div></div>

<hr />

<h1 id="step-9-test-the-connector-in-the-simulator">Step 9 Test the Connector in the Simulator</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this part of the tutorial, you’ll test the finished connector in the
simulator that’s part of the Web Data Connector SDK.</p>

<h2 id="test-the-finished-connector-in-the-simulator">Test the finished connector in the simulator</h2>

<p>You can now test the web data connector in the simulator. If you haven’t done so already, you need to follow the steps in <a href="/webdataconnector/docs/index.html">Getting Started</a> to install the components needed to run the simulator.</p>

<ol>
  <li>
    <p>Open a Command Prompt or shell window and navigate to the <code class="language-plaintext highlighter-rouge">webdataconnector</code> folder. This is the top-level folder if you downloaded or cloned the WDC repository. If you haven’t done so already, start the web server that runs the simulator.</p>

    <p><code class="language-plaintext highlighter-rouge">npm start</code></p>
  </li>
  <li>
    <p>Start the simulator by entering the following in your browser:</p>

    <p><code class="language-plaintext highlighter-rouge">localhost:8888/simulator/</code></p>

    <p>(As before, we’re assuming that the server is listening on
port 8888.)</p>
  </li>
  <li>
    <p>In the <strong>WDC URL</strong> box at the top of the
simulator, enter the path to the foursquare connector:</p>

    <p><code class="language-plaintext highlighter-rouge">../Examples/foursquareWDC/public</code></p>
  </li>
  <li>
    <p>Click the <strong>Start Interactive Phase</strong> button.</p>

    <p>The simulator opens a window and displays the UI for the Foursquare
web data connector.</p>

    <p><img src="/webdataconnector/assets/wdc_oauth_tutorial_test_in_simulator.png" alt="" /></p>
  </li>
  <li>
    <p>If the page indicates that you’re not logged in to Foursquare, click
the <strong>Connect to Foursquare</strong> button and
log in.</p>
  </li>
  <li>
    <p>After you have logged in, click the <strong>Get Venues I Like</strong> button.</p>

    <p>The simulator closes the window that displayed the UI phase of the
connector and returns to the main simulator window. At the bottom of
the main simulator window, the simulator displays the column names
and the types for the table schema you defined.</p>
  </li>
  <li>
    <p>Click <strong>Fetch Table Data</strong> to display the values for any venues that
you’ve “Liked” on Foursquare.</p>

    <p><img src="/webdataconnector/assets/wdc_oauth_tutorial_simulator_data.png" alt="" /></p>

    <p>Notice also that the simulator has filled the <strong>Password</strong> box with the authentication token.
Remember that in your code, when you got the authentication token
back from Foursquare, you set the <code class="language-plaintext highlighter-rouge">tableau.password</code> property to the
token value. When you run the simulator, after the UI phase is done,
the simulator displays the values of <code class="language-plaintext highlighter-rouge">tableau</code> object properties.</p>

    <p><strong>Note:</strong> If you see the message that you are already signed in, and you want to test the sign in process, you might need to delete cookies from your browsing history. For example, in Chrome, go to <strong>Settings</strong>, click <strong>Advanced</strong>, and choose <strong>Clear Browsing Data</strong>.</p>
  </li>
</ol>

<hr />

<h1 id="step-10-test-the-connector-in-tableau">Step 10 Test the Connector in Tableau</h1>

<p><a href="#top">(Back to top)</a></p>

<p>In this final part of the tutorial, you’ll use your connector in Tableau
to display a map that includes locations that you’ve “Liked” in
Foursquare.</p>

<h2 id="test-in-tableau">Test in Tableau</h2>

<p>The OAuth Foursquare web data connector is complete! You can now test it
in Tableau.</p>

<ol>
  <li>
    <p>Make sure you have “Liked” at least a few venues on Foursquare, or
you won’t have any data to view in Tableau.</p>
  </li>
  <li>
    <p>Open Tableau.</p>
  </li>
  <li>
    <p>In the <strong>Connect</strong> pane, under <strong>To a Server</strong>, 
choose <strong>Web Data Connector</strong>. You might need to choose <strong>More…</strong> to find it.</p>
  </li>
</ol>

<p><!--    ![](/webdataconnector/assets/wdc_tutorial_oauth_viz.png) --></p>

<ol>
  <li>
    <p>Enter the URL of your connector
(<code class="language-plaintext highlighter-rouge">http://localhost:3333</code>).</p>
  </li>
  <li>
    <p>Click the <strong>Connect to Foursquare</strong> button and sign in.</p>
  </li>
  <li>
    <p>In the connector, click <strong>Get Venues I Like</strong>.</p>

    <p><img src="/webdataconnector/assets/wdc_tutorial_oauth_signed_in_ui.png" alt="" /></p>
  </li>
  <li>
    <p>The connector creates an extract that contains information about the
venues you have liked on Foursquare, and Tableau opens a workbook
that uses the extract.</p>
  </li>
</ol>

<p>To see what the data looks like in Tableau, do this:</p>

<ol>
  <li>
    <p>Drag <strong>Longitude</strong> to the <strong>Columns</strong> shelf.</p>
  </li>
  <li>
    <p>Drag <strong>Latitude</strong> to the <strong>Rows</strong> shelf.</p>
  </li>
  <li>
    <p>Drag <strong>Name</strong> to <strong>Label</strong> in the
Marks card.</p>
  </li>
  <li>
    <p>Drag <strong>Address</strong> to <strong>Details</strong> in the
Marks card.</p>

    <p>The viz displays a map that shows places you’ve “Liked.”</p>

    <p><img src="/webdataconnector/assets/wdc_tutorial_oauth_viz.png" alt="" /></p>
  </li>
</ol>

<hr />

<h1 id="complete-code-listing">Complete Code Listing</h1>

<p><a href="#top">(Back to top)</a></p>

<p>This page provides complete code listings (<code class="language-plaintext highlighter-rouge">foursquareWDC.html</code> and foursquareWDC.js) for the web data connector Node Proxy OAuth client tutorial (app.js and config.js).</p>

<h2 id="foursquarewdchtml-page">FoursquareWDC.html page</h2>

<p><strong>Note</strong>: This listing includes a reference to the <code class="language-plaintext highlighter-rouge">tableauwdc-2.2.latest.js</code>
To connect to a web data connector that uses that version of the WDC
library, you must be using a recent version of Tableau. For more
information, see <a href="/webdataconnector/docs/wdc_library_versions.html">Web Data Connector Library
Versions</a>.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Foursquare Connector<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Cache-Control"</span> <span class="na">content=</span><span class="s">"no-store"</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- Latest compiled and minified CSS --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Optional theme --&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Latest compiled and minified JavaScript --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- Latest WDC Library --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://connectors.tableau.com/libs/tableauwdc-2.2.latest.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- Use to access cookie storage to grab access token --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.2/js.cookie.min.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="c">&lt;!-- This will contain all of your OAuth code --&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"./foursquareWDC.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"margin: auto; text-align: center; margin-top: 50px; max-width: 300px"</span><span class="nt">&gt;</span>
      <span class="c">&lt;!-- These labels will toggle depending on whether the user is authenticated or not --&gt;</span>
      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"signedin"</span><span class="nt">&gt;</span>You are signed in!<span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"notsignedin"</span><span class="nt">&gt;</span>You are not signed in, please click below to sign in to your Foursquare account.<span class="nt">&lt;/p&gt;</span>

      <span class="c">&lt;!-- The connect to Foursquare button will have a link added to it in the js--&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">id=</span><span class="s">"connectbutton"</span><span class="nt">&gt;&lt;img</span> <span class="na">src=</span><span class="s">"./foursquare_connect.png"</span> <span class="na">alt=</span><span class="s">"Login with Foursquare"</span><span class="nt">/&gt;&lt;/a&gt;</span>
      <span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span>

      <span class="c">&lt;!-- This button will pull the user's liked venues once the user is authenticated --&gt;</span>
      <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-block"</span> <span class="na">id=</span><span class="s">"getvenuesbutton"</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">"glyphicon glyphicon-arrow-down"</span><span class="nt">&gt;&lt;/span&gt;</span> Get Venues I Like<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="foursquarewdcjs">FoursquareWDC.js</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

  <span class="c1">// This config stores the important strings needed to</span>
  <span class="c1">// connect to the foursquare API and OAuth service to</span>
  <span class="c1">// gain authorization that we then exchange for an access  </span>
  <span class="c1">// token.</span>
  <span class="c1">//</span>
  <span class="c1">// Do not store your client secret here. </span>
  <span class="c1">// We are using a server-side OAuth flow, and the client </span>
  <span class="c1">// secret is kept on the web server. </span>
  <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">YOUR_CLIENT_ID</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">redirectUri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3333/redirect</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">authUrl</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://foursquare.com/</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">version</span><span class="p">:</span> <span class="dl">'</span><span class="s1">20190102</span><span class="dl">'</span>
  <span class="p">};</span> 
   <span class="c1">//  more code goes here</span>
   
  <span class="c1">// This function parses the access token in the URI if available</span>
  <span class="c1">// It also adds a link to the foursquare connect button</span>
  <span class="nf">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nf">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">accessToken</span><span class="dl">"</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hasAuth</span> <span class="o">=</span> <span class="nx">accessToken</span> <span class="o">&amp;&amp;</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">);</span>

      <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#connectbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nf">doAuthRedirect</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#getvenuesbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nx">connectionName</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Foursquare Venues Data</span><span class="dl">"</span><span class="p">;</span>
          <span class="nx">tableau</span><span class="p">.</span><span class="nf">submit</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">});</span>
 
  <span class="c1">// An on-click function for the connect to foursquare button,</span>
  <span class="c1">// This will redirect the user to a foursquare login</span>
  <span class="kd">function</span> <span class="nf">doAuthRedirect</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurpose</span> <span class="o">===</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurposeEnum</span><span class="p">.</span><span class="nx">ephemerel</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span>  <span class="c1">// This should be Desktop</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurpose</span> <span class="o">===</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authPurposeEnum</span><span class="p">.</span><span class="nx">enduring</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">appId</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">clientId</span><span class="p">;</span> <span class="c1">// This should be the Tableau Server appID</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">authUrl</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">oauth2/authenticate?response_type=code&amp;client_id=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">appId</span> <span class="o">+</span>
              <span class="dl">'</span><span class="s1">&amp;redirect_uri=</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">redirectUri</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
  <span class="p">}</span> 
   
  <span class="c1">//------------- OAuth Helpers -------------//</span>
  <span class="c1">// This helper function returns the URI for the venueLikes endpoint</span>
  <span class="c1">// It appends the passed in accessToken to the call to personalize the call for the user</span>
  <span class="kd">function</span> <span class="nf">getVenueLikesURI</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="dl">"</span><span class="s2">https://api.foursquare.com/v2/users/self/venuelikes?oauth_token=</span><span class="dl">"</span> <span class="o">+</span>
              <span class="nx">accessToken</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;v=</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// This function toggles the label shown depending</span>
  <span class="c1">// on whether or not the user has been authenticated</span>
  <span class="kd">function</span> <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.notsignedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.signedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.notsignedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">);</span>
          <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.signedin</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1">//------------- Tableau WDC code -------------//</span>
  <span class="c1">// Create tableau connector, should be called first</span>
  <span class="kd">var</span> <span class="nx">myConnector</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nf">makeConnector</span><span class="p">();</span>

  <span class="c1">// Init function for connector, called during every phase but</span>
  <span class="c1">// only called when running inside the simulator or tableau</span>
  <span class="nx">myConnector</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">initCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">tableau</span><span class="p">.</span><span class="nx">authType</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">authTypeEnum</span><span class="p">.</span><span class="nx">custom</span><span class="p">;</span>

      <span class="c1">// If we are in the auth phase we only want to show the UI needed for auth</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#getvenuesbutton</span><span class="dl">"</span><span class="p">).</span><span class="nf">css</span><span class="p">(</span><span class="dl">'</span><span class="s1">display</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">gatherDataPhase</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If API that WDC is using has an endpoint that checks</span>
        <span class="c1">// the validity of an access token, that could be used here.</span>
        <span class="c1">// Then the WDC can call tableau.abortForAuth if that access token</span>
        <span class="c1">// is invalid.</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">accessToken</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access token is '</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">accessToken</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">'</span><span class="dl">"</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hasAuth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">accessToken</span> <span class="o">&amp;&amp;</span> <span class="nx">accessToken</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nf">updateUIWithAuthState</span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">);</span>

      <span class="nf">initCallback</span><span class="p">();</span>

      <span class="c1">// If we are not in the data gathering phase, we want to store the token</span>
      <span class="c1">// This allows us to access the token in the data gathering phase</span>
      <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">interactivePhase</span> <span class="o">||</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">if </span><span class="p">(</span><span class="nx">hasAuth</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">accessToken</span><span class="p">;</span>

              <span class="nf">if </span><span class="p">(</span><span class="nx">tableau</span><span class="p">.</span><span class="nx">phase</span> <span class="o">==</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">phaseEnum</span><span class="p">.</span><span class="nx">authPhase</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Auto-submit here if we are in the auth phase</span>
                <span class="nx">tableau</span><span class="p">.</span><span class="nf">submit</span><span class="p">()</span>
              <span class="p">}</span>

              <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">// Declare the data to Tableau that we are returning from Foursquare</span>
  <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getSchema</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">schemaCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="kd">var</span> <span class="nx">col1</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Name</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">col2</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Latitude</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">col3</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Longitude</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">float</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">col4</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Address</span><span class="dl">"</span><span class="p">,</span> <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">cols</span> <span class="o">=</span> <span class="p">[</span><span class="nx">col1</span><span class="p">,</span> <span class="nx">col2</span><span class="p">,</span> <span class="nx">col3</span><span class="p">,</span> <span class="nx">col4</span><span class="p">];</span>

      <span class="kd">var</span> <span class="nx">tableInfo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">FoursquareTable</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">columns</span><span class="p">:</span> <span class="nx">cols</span>
      <span class="p">}</span>

      <span class="nx">schema</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">tableInfo</span><span class="p">);</span>

      <span class="nf">schemaCallback</span><span class="p">(</span><span class="nx">schema</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// This function actually make the foursquare API call and</span>
  <span class="c1">// parses the results and passes them back to Tableau</span>
  <span class="nx">myConnector</span><span class="p">.</span><span class="nx">getData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">doneCallback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dataToReturn</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">hasMoreData</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">tableau</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">connectionUri</span> <span class="o">=</span> <span class="nf">getVenueLikesURI</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nf">ajax</span><span class="p">({</span>
          <span class="na">url</span><span class="p">:</span> <span class="nx">connectionUri</span><span class="p">,</span>
          <span class="na">dataType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">success</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
              <span class="nf">if </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">venues</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">venues</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>

                  <span class="kd">var</span> <span class="nx">ii</span><span class="p">;</span>
                  <span class="nf">for </span><span class="p">(</span><span class="nx">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ii</span> <span class="o">&lt;</span> <span class="nx">venues</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">ii</span><span class="p">)</span> <span class="p">{</span>
                      <span class="kd">var</span> <span class="nx">venue</span> <span class="o">=</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Name</span><span class="dl">'</span><span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">name</span><span class="p">,</span>
                                   <span class="dl">'</span><span class="s1">Latitude</span><span class="dl">'</span><span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">location</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span>
                                   <span class="dl">'</span><span class="s1">Longitude</span><span class="dl">'</span><span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">location</span><span class="p">.</span><span class="nx">lng</span><span class="p">,</span>
                                   <span class="dl">'</span><span class="s1">Address</span><span class="dl">'</span> <span class="p">:</span> <span class="nx">venues</span><span class="p">[</span><span class="nx">ii</span><span class="p">].</span><span class="nx">location</span><span class="p">.</span><span class="nx">address</span><span class="p">};</span>
                      <span class="nx">dataToReturn</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">venue</span><span class="p">);</span>
                  <span class="p">}</span>

                  <span class="nx">table</span><span class="p">.</span><span class="nf">appendRows</span><span class="p">(</span><span class="nx">dataToReturn</span><span class="p">);</span>
                  <span class="nf">doneCallback</span><span class="p">();</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">tableau</span><span class="p">.</span><span class="nf">abortWithError</span><span class="p">(</span><span class="dl">"</span><span class="s2">No results found</span><span class="dl">"</span><span class="p">);</span>
              <span class="p">}</span>
          <span class="p">},</span>
          <span class="na">error</span><span class="p">:</span> <span class="nf">function </span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">ajaxOptions</span><span class="p">,</span> <span class="nx">thrownError</span><span class="p">)</span> <span class="p">{</span>
              <span class="c1">// WDC should do more granular error checking here</span>
              <span class="c1">// or on the server side.  This is just a sample of new API.</span>
              <span class="nx">tableau</span><span class="p">.</span><span class="nf">abortForAuth</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid Access Token</span><span class="dl">"</span><span class="p">);</span>
          <span class="p">}</span>
      <span class="p">});</span>
  <span class="p">};</span>

  <span class="c1">// Register the tableau connector, call this last</span>
  <span class="nx">tableau</span><span class="p">.</span><span class="nf">registerConnector</span><span class="p">(</span><span class="nx">myConnector</span><span class="p">);</span>
  

<span class="p">})();</span>  <span class="c1">// end of anonymous function</span>
</code></pre></div></div>

<h2 id="configjs">Config.js</h2>

<p>Configuration file for Node.js Express web server.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The necessary configuration for your server</span>
<span class="c1">// Contains credentials for your Foursquare application</span>
<span class="c1">// And the new redirect path for the OAuth flow</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
 <span class="dl">'</span><span class="s1">HOSTPATH</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">PORT</span><span class="dl">'</span><span class="p">:</span> <span class="mi">3333</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">CLIENT_ID</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">YOUR_CLIENT_ID</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">CLIENT_SECRET</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">YOUR_CLIENT_SECRET</span><span class="dl">'</span><span class="p">,</span>
 <span class="dl">'</span><span class="s1">REDIRECT_PATH</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/redirect</span><span class="dl">'</span>
<span class="p">};</span>

</code></pre></div></div>

<h2 id="appjs">app.js</h2>

<p>Express web server, using Node.js.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// -------------------------------------------------- //</span>
<span class="c1">// Module Dependencies</span>
<span class="c1">// -------------------------------------------------- //</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">querystring</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">querystring</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./config.js</span><span class="dl">'</span><span class="p">);</span>              <span class="c1">// Get our config info (app id and app secret)</span>
<span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">util</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="c1">// -------------------------------------------------- //</span>
<span class="c1">// Express set-up and middleware</span>
<span class="c1">// -------------------------------------------------- //</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="nx">config</span><span class="p">.</span><span class="nx">PORT</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cookieParser</span><span class="p">());</span>                                    <span class="c1">// cookieParser middleware to work with cookies</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nf">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/public</span><span class="dl">'</span><span class="p">));</span>

<span class="c1">// -------------------------------------------------- //</span>
<span class="c1">// Variables</span>
<span class="c1">// -------------------------------------------------- //</span>
<span class="kd">var</span> <span class="nx">clientID</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FOURSQUARE_CLIENT_ID</span> <span class="o">||</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CLIENT_ID</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">clientSecret</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FOURSQUARE_CLIENT_SECRET</span> <span class="o">||</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CLIENT_SECRET</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">clientID</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">clientSecret</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">redirectURI</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">HOSTPATH</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">:</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">REDIRECT_PATH</span>

<span class="c1">// -------------------------------------------------- //</span>
<span class="c1">// Routes</span>
<span class="c1">// -------------------------------------------------- //</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">got here</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/index.html</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// This route is hit once Foursquare redirects to our</span>
<span class="c1">// server after performing authentication</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/redirect</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// get our authorization code</span>
  <span class="nx">authCode</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Auth Code is: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">authCode</span><span class="p">);</span>

  <span class="c1">// Set up a request for an long-lived Access Token now that we have a code</span>
  <span class="kd">var</span> <span class="nx">requestObject</span> <span class="o">=</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">client_id</span><span class="dl">'</span><span class="p">:</span> <span class="nx">clientID</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">redirect_uri</span><span class="dl">'</span><span class="p">:</span> <span class="nx">redirectURI</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">client_secret</span><span class="dl">'</span><span class="p">:</span> <span class="nx">clientSecret</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">:</span> <span class="nx">authCode</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">grant_type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">authorization_code</span><span class="dl">'</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">token_request_header</span> <span class="o">=</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/x-www-form-urlencoded</span><span class="dl">'</span>
  <span class="p">};</span>

  <span class="c1">// Build the post request for the OAuth endpoint</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://foursquare.com/oauth2/access_token</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">form</span><span class="p">:</span> <span class="nx">requestObject</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="nx">token_request_header</span>
  <span class="p">};</span>

  <span class="c1">// Make the request</span>
  <span class="nf">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We should receive  { access_token: ACCESS_TOKEN }</span>
      <span class="c1">// if everything went smoothly, so parse the token from the response</span>
      <span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">accessToken: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">accessToken</span><span class="p">);</span>

      <span class="c1">// Set the token in cookies so the client can access it</span>
      <span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">accessToken</span><span class="dl">'</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>

      <span class="c1">// Head back to the WDC page</span>
      <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/index.html</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">});</span>


<span class="c1">// -------------------------------------------------- //</span>
<span class="c1">// Create and start our server</span>
<span class="c1">// -------------------------------------------------- //</span>
<span class="nx">http</span><span class="p">.</span><span class="nf">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">).</span><span class="nf">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">),</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Express server listening on port </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">port</span><span class="dl">'</span><span class="p">));</span>
<span class="p">});</span>


</code></pre></div></div>

<p><a href="#top">(Back to top)</a></p>

            <!-- Footer -->
<footer>
    <div class="row">
            <hr class="footer-hr">
            <p>This site is open source. Suggestions and pull requests are welcome on our <a href="https://github.com/tableau/webdataconnector">GitHub page</a>.</p>
            <p><a href="https://www.tableau.com/en-us/legal" class="aLegal">LEGAL</a> <a href="https://www.salesforce.com/company/privacy/" class="aLegal">PRIVACY</a> &copy; 2003&ndash;<script>document.write(new Date().getFullYear())</script> TABLEAU SOFTWARE LLC. ALL RIGHTS RESERVED</p>
            <sub>Documentation last generated on: 2023-03-07 13:27:13 -0800</sub>
    </div>
</footer>

        </div>
    </div>
</body>

</html>
